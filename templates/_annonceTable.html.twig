<table id="annonceTable" class="table table-striped" data-order='[[ 12, "desc" ]]'>
    <thead>
        <tr>
            <th>ID</th> {# link #}
            <th>Image</th> {# link #}
            <th>Titre</th> {# titre + type #}
            <th>Annonceur</th>
            <th>Année</th>
            <th>Prix</th>
            <th>Surface</th>
            <th>Prix/m²</th>
            <th>Etage</th>
            <th>Adresse</th>
            <th>DPE</th> {# DPE + GES #}
            <th>Carracteristiques</th>
            <th>Date Ajout</th>
            <th>Actions</th> {# fav, del, link, detail (photo + desc) #}
        </tr>
        <tr>
            <th>ID</th>
            <th>Image</th>
            <th>Titre</th>
            <th>Annonceur</th>
            <th>Année</th>
            <th>Prix</th>
            <th>Surface</th>
            <th>Prix/m²</th>
            <th>Etage</th>
            <th>Adresse</th>
            <th>DPE</th>
            <th>Carracteristiques</th>
            <th>Date Ajout</th>
            <th><button id="resetFilters" class="btn btn-warning btn-sm" title="Reset tous les filtres"><i class="fas fa-undo"></i></button></th>
        </tr>
    </thead>
    <tbody>
        {% for annonce in annonces %}
            {% set surfaceCalc = (annonce.prix/annonce.prixSurface??1)|round %}
            {% set isCorrectPrice = (surfaceCalc > 200 or surfaceCalc == annonce.surface or surfaceCalc+1 == annonce.surface or surfaceCalc-1 == annonce.surface) %}
            <tr data-id="{{ annonce.id }}">
                <td style="min-width: 120px;"><a href="{{ annonce.lien }}">#{{ annonce.id }}</a></td>
                <td style="min-width: 140px;">
                    {% if annonce.photos|length > 0 %}
                        <img src="{{ annonce.photos[0].url }}" style="height: 74px; padding: 3px;">
                    {% endif %}
                </td>
                <td style="min-width: 150px;">{{ annonce.titre }}</td>
                <td style="min-width: 100px;">{{ annonce.annonceur }}</td>
                <td style="min-width: 60px;">{{ annonce.dateConstruction|date('Y') }}</td>
                <td style="min-width: 90px;" data-order="{{ annonce.prix }}">{{ annonce.prix|number_format(0, '.', ' ') }}€</td>
                <td style="min-width: 60px; {{ isCorrectPrice?'':'color: red;' }}" data-order="{{ annonce.surface }}">{{ annonce.surface }}m²{{ isCorrectPrice?'':('<br />'~(annonce.prix/annonce.prixSurface??1)|round~'m²')|raw }}</td>
                <td style="min-width: 150px; {{ (annonce.prixSurface <= 3900)?'color: green;':(annonce.prixSurface <= 4900)?'color: yellow;':'color: red;' }}" data-order="{{ annonce.prixSurface??((annonce.prix/annonce.surface)|round) }}">
                    {{ annonce.prixSurface??((annonce.prix/annonce.surface)|round) }}€/m²
                </td>
                <td style="min-width: 100px; {{ (annonce.etageMax > 4 and annonce.etage >= annonce.etageMax-2)?'color: green;':(annonce.etage <= 1)?'color: red;':'color: yellow;' }}">
                    {{ annonce.etage }} / {{ annonce.etageMax }}
                </td>
                <td style="min-width: 200px;">{{ annonce.adresse }}</td>
                <td style="min-width: 50px; {{ (annonce.dpe in ['A', 'B', 'C'])?'color: green;':(annonce.dpe in ['D', 'E'])?'color: yellow;':'color: red;' }}">{{ annonce.dpe }}<br />{{ annonce.ges }}</td>
                <td style="min-width: 180px;">
                    {{ include('_caracIcone.html.twig', {'caracteristiques':annonce.caracteristiques}) }}
                </td>
                {# <td style="min-width: 150px;">{{ annonce.chauffageSource }}<br />{{ annonce.chauffageType|replace({'Chauffage ': ''}) }}</td> #}
                <td style="min-width: 100px;">{{ annonce.createdAt|date('Y-m-d H:i:s') }}</td>
                <td style="min-width: 50px;">
                    <button data-id="{{ annonce.id }}" class="btn-sm btn-info info"><i class="fa-solid fa-info"></i></button>
                    {# <button data-id="{{ annonce.id }}" class="btn-sm btn-success accept"><i class="fa-solid fa-check"></i></button> #}
                    {# <button data-id="{{ annonce.id }}" class="btn-sm btn-danger remove"><i class="fa-solid fa-xmark"></i></button> #}
                </td>
            </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    $(document).ready(function() {
        let table = new DataTable('#annonceTable', {
            searching: true,
            dom: 't<"row"<"col-sm-12 col-md-4"i><"col-sm-12 col-md-4 text-center"p><"col-sm-12 col-md-4 text-end"l>>',
            language: {
                search: "",
            },
            orderCellsTop: true,
            initComplete: function () {
                // Masquer la recherche globale
                $('.dataTables_filter').hide();

                this.api().columns().every(function (index) {
                    let column = this;
                    let title = column.header().textContent;

                    if(title === 'Actions' || title.length <= 0) {
                        // Ne rien faire pour Actions
                    } else if(title === 'Annonceur') {
                        // Créer un input avec datalist pour l'autocomplétion
                        let input = document.createElement('input');
                        input.placeholder = 'Annonceur';
                        input.className = 'form-control form-control-sm column-search';
                        input.setAttribute('list', 'annonceurs-list');

                        let datalist = document.createElement('datalist');
                        datalist.id = 'annonceurs-list';

                        // Récupérer les valeurs uniques de la colonne
                        column.data().unique().sort().each(function(d) {
                            if(d) {
                                let option = document.createElement('option');
                                option.value = d;
                                datalist.appendChild(option);
                            }
                        });

                        let container = document.createElement('div');
                        container.appendChild(input);
                        container.appendChild(datalist);

                        $('#annonceTable thead tr:eq(1) th:eq(' + index + ')').html(container);

                        input.addEventListener('keyup', () => {
                            if (column.search() !== input.value) {
                                column.search(input.value).draw();
                            }
                        });
                    } else {
                        let input = document.createElement('input');
                        input.placeholder = title;
                        input.className = 'form-control form-control-sm column-search';

                        $('#annonceTable thead tr:eq(1) th:eq(' + index + ')').html(input);

                        input.addEventListener('keyup', () => {
                            if (column.search() !== input.value) {
                                column.search(input.value).draw();
                            }
                        });
                    }
                });
            }
        });

        // Bouton reset
        $('#resetFilters').on('click', function() {
            $('.column-search').val('');
            table.search('').columns().search('').draw();
        });

        // Ouvrir la popup
        $('body').on('click', 'button.info', function() {
            let annonceId = $(this).data('id');
            $('#popupOverlay').fadeIn(200).addClass('show');
            $('.content').html('<div class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>');

            // Charger le contenu via AJAX
            $.get('annonce-modal/' + annonceId)
                .done(function(data) {
                    $('.content').html(data);
                })
                .fail(function() {
                    $('.content').html('<div class="alert alert-danger">Erreur lors du chargement</div>');
                });
        });

        // Fermer via la croix
        $('.close').on('click', function() {
            $('#popupOverlay').fadeOut(200).removeClass('show');
        });

        // Fermer en cliquant en dehors
        $('#popupOverlay').on('click', function(e) {
            if ($(e.target).is('#popupOverlay')) {
                $('#popupOverlay').fadeOut(200).removeClass('show');
            }
        });

        // Fermer avec la touche ESC
        $(document).on('keydown', function(e) {
            if (e.key === "Escape") {
                $('#popupOverlay').fadeOut(200).removeClass('show');
            }
        });

        // Centrer la pagination
        $('.dataTables_paginate').parent().addClass('text-center');
    });
</script>

<style>
.dataTables_wrapper .dataTables_paginate {
    text-align: center;
}
.dataTables_wrapper .dataTables_length {
    text-align: right;
}
.dataTables_wrapper .dataTables_info {
    text-align: left;
}
#annonceTable_wrapper .text-end {
    display: flex;
    align-items: center;
    justify-content: right;
}

/* Désactiver le tri sur la deuxième ligne de header */
#annonceTable thead tr:nth-child(2) th {
    cursor: default !important;
}
#annonceTable thead tr:nth-child(2) th:before,
#annonceTable thead tr:nth-child(2) th:after {
    display: none !important;
}

bles_paginate {
    text-align: center;
}
.dataTables_wrapper .dataTables_length {
    text-align: right;
}
.dataTables_wrapper .dataTables_info {
    text-align: left;
}
#annonceTable_wrapper .text-end {
    display: flex;
    align-items: center;
    justify-content: right;
}

</style>
